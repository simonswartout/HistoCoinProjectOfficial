<!DOCTYPE html>
<html lang="en" class="scroll-smooth" data-atlas-endpoint="https://worker-atlas.YOUR_WORKERS_SUBDOMAIN.workers.dev">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HistoGraphPublic | The Library of Alexandria for the Open Web</title>
    <meta name="description"
        content="HistoGraphPublic is the living library of historical archives—distributed, validator-backed, and open to every researcher on Earth.">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600&family=Space+Grotesk:wght@400;500;600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4QF2xLClL3DGb5mQw8JE0bNwV1t6vKpYhV+3rJTsw0=" crossorigin="" />
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        parchment: '#f2e8cf',
                        midnight: '#0a0a0f',
                        ember: '#ff8a00',
                        tealight: '#6efacc',
                    },
                    fontFamily: {
                        serif: ['Cinzel', 'serif'],
                        sans: ['Space Grotesk', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background: radial-gradient(circle at top, rgba(255, 138, 0, 0.07), transparent 55%), #050509;
            color: #f9fafb;
        }

        .glass {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(16px);
        }

        .grid-bg {
            background-image: linear-gradient(rgba(255, 255, 255, 0.02) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.02) 1px, transparent 1px);
            background-size: 80px 80px;
        }
        .atlas-modal {
            background: rgba(0, 0, 0, 0.8);
        }

        #atlasMap {
            min-height: 60vh;
        }

        .timeline-track {
            background: rgba(255, 255, 255, 0.08);
        }

        .atlas-tab {
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: rgba(255, 255, 255, 0.7);
            text-transform: uppercase;
            letter-spacing: 0.2em;
            transition: all 0.2s ease;
        }

        .atlas-tab.is-active {
            background: #ff8a00;
            color: #050509;
            border-color: rgba(255, 138, 0, 0.7);
        }
    </style>
</head>

<body class="font-sans antialiased selection:bg-ember selection:text-midnight">
    <header class="fixed top-0 inset-x-0 z-50 glass">
        <div class="max-w-6xl mx-auto px-6 h-20 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <i data-lucide="library" class="text-ember h-8 w-8"></i>
                <div>
                    <p class="font-serif text-xl tracking-[0.3em]">HISTO</p>
                    <p class="font-serif text-xl tracking-[0.3em] -mt-2">GRAPH</p>
                </div>
            </div>
            <nav class="hidden md:flex gap-8 text-sm uppercase tracking-widest text-gray-300 items-center">
                <a href="#mission" class="hover:text-ember">Mission</a>
                <a href="#pillars" class="hover:text-ember">Pillars</a>
                <a href="#timeline" class="hover:text-ember">Roadmap</a>
                <a href="#participate" class="hover:text-ember">Participate</a>
                <button data-open-atlas
                    class="inline-flex items-center gap-2 border border-white/20 px-4 py-2 rounded-full text-xs tracking-[0.3em] text-gray-100 hover:border-ember"
                    aria-haspopup="dialog">
                    ATLAS
                    <i data-lucide="globe" class="h-4 w-4"></i>
                </button>
            </nav>
            <a href="#participate"
                class="hidden sm:inline-flex items-center gap-2 border border-ember/60 px-4 py-2 rounded-full text-sm font-semibold text-ember">
                Access the Library
                <i data-lucide="arrow-up-right" class="h-4 w-4"></i>
            </a>
        </div>
    </header>

    <!-- Hero -->
    <section class="pt-32 pb-20 grid-bg">
        <div class="max-w-5xl mx-auto text-center px-6">
            <p class="uppercase tracking-[0.35em] text-ember text-xs mb-6">HistoGraphPublic Initiative</p>
            <h1 class="font-serif text-4xl sm:text-6xl leading-tight mb-6">
                The Library of Alexandria for the Internet of Historical Archives
            </h1>
            <p class="text-lg text-gray-300 max-w-3xl mx-auto mb-10">
                We are rebuilding humanity’s shared memory as a distributed, validator-backed knowledge graph.
                Nodes discover CC0 archives. Transformers verify provenance. Credentialed historians validate every
                claim. Together they form HistoGraphPublic—the living catalog of everything our species refuses to
                forget.
            </p>
            <div class="flex flex-col sm:flex-row items-center justify-center gap-4">
                <a href="#mission"
                    class="bg-ember/90 hover:bg-ember text-midnight font-semibold px-8 py-4 rounded-full flex items-center gap-3">
                    Explore the Mission
                    <i data-lucide="book-open-check" class="h-5 w-5"></i>
                </a>
                <a href="#participate" class="text-gray-200 hover:text-white flex items-center gap-2">
                    Run a Node
                    <i data-lucide="cpu" class="h-5 w-5"></i>
                </a>
                <button data-open-atlas
                    class="inline-flex items-center gap-2 text-gray-200 border border-white/20 px-6 py-3 rounded-full hover:border-ember">
                    View Atlas
                    <i data-lucide="globe" class="h-5 w-5"></i>
                </button>
            </div>
        </div>
    </section>

    <!-- Mission -->
    <section id="mission" class="py-24">
        <div class="max-w-6xl mx-auto px-6 grid lg:grid-cols-2 gap-16 items-center">
            <div>
                <p class="text-ember uppercase tracking-[0.4em] text-xs mb-4">Why HistoGraphPublic</p>
                <h2 class="font-serif text-3xl mb-6">Every archive deserves daylight.</h2>
                <p class="text-gray-300 leading-relaxed mb-4">
                    Museums digitize faster than institutions can index. Personal collections vanish when custodians pass
                    away. Community historians uncover fragments that never reach the public record. HistoGraphPublic
                    gathers these scattered shards into one open library, then publishes the evidence trail behind every
                    artifact.
                </p>
                <p class="text-gray-300 leading-relaxed">
                    The project is stewarded by HistoCoin validators, but the library itself remains public
                    infrastructure. Anyone can inspect the map, query the timeline, or request raw data for research
                    pipelines.
                </p>
            </div>
            <div class="glass rounded-3xl p-10 space-y-6">
                <div class="flex items-center gap-4">
                    <i data-lucide="satellite" class="h-10 w-10 text-tealight"></i>
                    <div>
                        <p class="font-semibold">73 active discovery nodes</p>
                        <p class="text-sm text-gray-400">CC0 crawlers across five continents.</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <i data-lucide="layers" class="h-10 w-10 text-ember"></i>
                    <div>
                        <p class="font-semibold">Multi-layer verification</p>
                        <p class="text-sm text-gray-400">Transformers flag CC0 compliance; credentialed historians make
                            the final ruling.</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <i data-lucide="globe" class="h-10 w-10 text-sky-300"></i>
                    <div>
                        <p class="font-semibold">Global impact</p>
                        <p class="text-sm text-gray-400">Artifacts plotted on an open map + temporal storyline anyone
                            can embed.</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Pillars -->
    <section id="pillars" class="py-24 bg-midnight/70">
        <div class="max-w-6xl mx-auto px-6 text-center">
            <p class="text-ember uppercase tracking-[0.4em] text-xs mb-4">Core Pillars</p>
            <h2 class="font-serif text-3xl mb-12">How the Library Stays Alive</h2>
            <div class="grid md:grid-cols-3 gap-8">
                <article class="glass rounded-2xl p-8 text-left">
                    <div class="flex items-center gap-3 mb-4">
                        <span class="text-2xl text-ember font-serif">01</span>
                        <h3 class="text-xl font-semibold">Collect</h3>
                    </div>
                    <p class="text-gray-300 text-sm">Volunteer nodes “mine” the open web for CC0 historical material—
                        archives, letters, 3D scans, oral histories. Each submission ships with raw context and crawl
                        proofs.</p>
                </article>
                <article class="glass rounded-2xl p-8 text-left">
                    <div class="flex items-center gap-3 mb-4">
                        <span class="text-2xl text-ember font-serif">02</span>
                        <h3 class="text-xl font-semibold">Verify</h3>
                    </div>
                    <p class="text-gray-300 text-sm">Transformer ensembles check licensing, provenance, and historical
                        claims. Items that clear the AI gate enter a review queue for accredited historians wielding
                        validator keys.</p>
                </article>
                <article class="glass rounded-2xl p-8 text-left">
                    <div class="flex items-center gap-3 mb-4">
                        <span class="text-2xl text-ember font-serif">03</span>
                        <h3 class="text-xl font-semibold">Illuminate</h3>
                    </div>
                    <p class="text-gray-300 text-sm">Approved artifacts materialize on the public map/timeline. Every
                        node’s contribution is credited, and educators can query the graph by era, region, or theme.</p>
                </article>
            </div>
        </div>
    </section>

    <!-- Storyline -->
    <section id="timeline" class="py-24">
        <div class="max-w-5xl mx-auto px-6">
            <p class="text-ember uppercase tracking-[0.4em] text-xs mb-4">Roadmap</p>
            <h2 class="font-serif text-3xl mb-10">Rebuilding Alexandria, milestone by milestone.</h2>
            <div class="space-y-10 border-l border-white/10 pl-6">
                <div>
                    <p class="text-sm text-gray-400 uppercase tracking-[0.3em] mb-2">Phase 01 · Now</p>
                    <h3 class="text-xl font-semibold mb-2">Node CLI + CC0 Sentinel</h3>
                    <p class="text-gray-300">Ship the TypeScript miner, bootstrap 300 training images, and deploy the
                        first transformer verifier checkpoint.</p>
                </div>
                <div>
                    <p class="text-sm text-gray-400 uppercase tracking-[0.3em] mb-2">Phase 02 · Q1</p>
                    <h3 class="text-xl font-semibold mb-2">Validator Guild Launch</h3>
                    <p class="text-gray-300">Onboard credentialed historians and issue cryptographic access tokens for
                        draft review + red-circle approvals.</p>
                </div>
                <div>
                    <p class="text-sm text-gray-400 uppercase tracking-[0.3em] mb-2">Phase 03 · Q2</p>
                    <h3 class="text-xl font-semibold mb-2">Atlas + Timeline Release</h3>
                    <p class="text-gray-300">Public map + cinematic timeline hosted on GitHub Pages with nightly data
                        snapshots from the master index.</p>
                </div>
                <div>
                    <p class="text-sm text-gray-400 uppercase tracking-[0.3em] mb-2">Phase 04 · Q3</p>
                    <h3 class="text-xl font-semibold mb-2">Scholar APIs</h3>
                    <p class="text-gray-300">GraphQL + bulk export interface for universities, game studios, and
                        documentary teams.</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Participate -->
    <section id="participate" class="py-24 bg-midnight/80">
        <div class="max-w-6xl mx-auto px-6 grid lg:grid-cols-2 gap-10 items-center">
            <div>
                <p class="text-ember uppercase tracking-[0.4em] text-xs mb-4">Participate</p>
                <h2 class="font-serif text-3xl mb-6">How you can extend the Library.</h2>
                <ul class="space-y-6">
                    <li class="flex gap-4">
                        <i data-lucide="cpu" class="h-6 w-6 text-tealight mt-1"></i>
                        <div>
                            <h3 class="font-semibold">Run a Node</h3>
                            <p class="text-sm text-gray-300">Use the headless CLI to contribute compute cycles. Point
                                it to archives you trust, share CC0 evidence, and earn reputation in the graph.</p>
                        </div>
                    </li>
                    <li class="flex gap-4">
                        <i data-lucide="graduation-cap" class="h-6 w-6 text-ember mt-1"></i>
                        <div>
                            <h3 class="font-semibold">Become a Validator</h3>
                            <p class="text-sm text-gray-300">Historians, archivists, and museum staff can request a
                                verification token to review drafts and issue red-circle approvals.</p>
                        </div>
                    </li>
                    <li class="flex gap-4">
                        <i data-lucide="share-2" class="h-6 w-6 text-sky-300 mt-1"></i>
                        <div>
                            <h3 class="font-semibold">Publish Interfaces</h3>
                            <p class="text-sm text-gray-300">Build your own viewers, lesson plans, or research tools on
                                top of the open map/timeline exports.</p>
                        </div>
                    </li>
                </ul>
                <div class="mt-10 glass rounded-2xl p-6">
                    <h3 class="font-semibold mb-3 flex items-center gap-2">
                        <i data-lucide="download" class="h-5 w-5 text-ember"></i>
                        Download the Node CLI
                    </h3>
                    <p class="text-sm text-gray-300 mb-4">Grab the prebuilt TypeScript bundle, copy it anywhere on
                        your machine, and run it with Node 18+. Includes sample sources + quick start guide.</p>
                    <a href="downloads/histograph-node.zip" class="inline-flex items-center gap-2 bg-ember text-midnight font-semibold px-5 py-3 rounded-full">
                        histograph-node.zip
                        <i data-lucide="arrow-down-circle" class="h-4 w-4"></i>
                    </a>
                </div>
            </div>
            <div class="glass rounded-3xl p-10">
                <h3 class="text-lg font-semibold mb-6">Get in touch</h3>
                <form class="space-y-4">
                    <input type="text" placeholder="Name" class="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3" />
                    <input type="email" placeholder="Email" class="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3" />
                    <textarea rows="4" placeholder="How would you like to help?" class="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3"></textarea>
                    <button type="button" class="w-full bg-ember text-midnight font-semibold rounded-xl py-3">Send
                        message</button>
                </form>
                <p class="text-xs text-gray-500 mt-4">Prefer email? <a class="underline text-ember"
                        href="mailto:simon@luminarylabs.dev">simon@luminarylabs.dev</a></p>
            </div>
        </div>
    </section>

    <footer class="py-12 text-center text-gray-500 text-sm">
        <p>HistoGraphPublic · stewarded by Luminary Labs · 2025</p>
    </footer>

    <!-- Atlas Modal -->
    <div id="atlasModal" class="fixed inset-0 hidden atlas-modal z-[60]" role="dialog"
        aria-modal="true" aria-labelledby="atlasTitle">
        <div class="w-full h-full flex flex-col">
            <div class="flex items-center justify-between px-8 py-4 border-b border-white/10 bg-black/40">
                <div>
                    <p class="text-ember uppercase tracking-[0.3em] text-xs">Global Atlas</p>
                    <h2 id="atlasTitle" class="font-serif text-2xl">Artifacts Map & Timeline</h2>
                </div>
                <div class="flex items-center gap-3">
                    <button id="timelineReset" class="text-sm text-gray-300 hover:text-white">Reset timeline</button>
                    <button id="closeAtlasBtn"
                        class="rounded-full border border-white/20 p-3 text-gray-200 hover:text-white"
                        aria-label="Close atlas">
                        <i data-lucide="x"></i>
                    </button>
                </div>
            </div>
            <div class="px-8 py-3 border-b border-white/10 bg-black/30 flex gap-2 flex-wrap">
                <button class="atlas-tab px-4 py-2 rounded-full text-sm" data-view-target="atlas">Atlas</button>
                <button class="atlas-tab px-4 py-2 rounded-full text-sm" data-view-target="sources">Sources</button>
                <button class="atlas-tab px-4 py-2 rounded-full text-sm" data-view-target="artifacts">Artifacts</button>
            </div>
            <div class="flex-1 overflow-hidden">
                <section id="atlasView" data-view="atlas" class="h-full flex flex-col">
                    <div id="atlasMap" class="flex-1"></div>
                    <div class="glass p-6 border-t border-white/5">
                        <div class="flex flex-col gap-6">
                            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                                <div>
                                    <p class="text-xs uppercase tracking-[0.4em] text-ember">Timeline Window</p>
                                    <p class="text-lg" id="timelineLabel">All years</p>
                                </div>
                                <div class="text-xs text-gray-500 uppercase tracking-[0.3em]">
                                    Drag both handles to focus on a specific era
                                </div>
                            </div>
                            <div class="grid gap-6 md:grid-cols-2">
                                <div>
                                    <label for="timelineStartSlider"
                                        class="text-xs uppercase tracking-[0.4em] text-gray-400">Start</label>
                                    <input id="timelineStartSlider" type="range" min="-5000" max="2025" step="25"
                                        class="w-full accent-ember">
                                    <p class="text-xs text-gray-500 mt-1" id="timelineStartLabel">5000&nbsp;BCE</p>
                                </div>
                                <div>
                                    <label for="timelineEndSlider"
                                        class="text-xs uppercase tracking-[0.4em] text-gray-400">End</label>
                                    <input id="timelineEndSlider" type="range" min="-5000" max="2025" step="25"
                                        class="w-full accent-ember">
                                    <p class="text-xs text-gray-500 mt-1" id="timelineEndLabel">2025&nbsp;CE</p>
                                </div>
                            </div>
                            <div class="flex justify-between text-xs text-gray-500">
                                <span>5000&nbsp;BCE</span>
                                <span>2000&nbsp;BCE</span>
                                <span>0</span>
                                <span>1200&nbsp;CE</span>
                                <span>2025&nbsp;CE</span>
                            </div>
                        </div>
                    </div>
                </section>
                <section id="sourcesView" data-view="sources" class="hidden h-full overflow-y-auto">
                    <div class="p-8 space-y-6">
                        <div>
                            <p class="text-xs uppercase tracking-[0.4em] text-ember">Source Registry</p>
                            <p class="text-lg text-gray-200">Immutable view of crawlers and archives referenced by the network.</p>
                        </div>
                        <div id="sourcesList" class="grid md:grid-cols-2 gap-4"></div>
                    </div>
                </section>
                <section id="artifactsView" data-view="artifacts" class="hidden h-full overflow-y-auto">
                    <div class="p-8 space-y-6">
                        <div class="flex flex-col lg:flex-row lg:items-end gap-4">
                            <div class="flex-1">
                                <label class="text-xs uppercase tracking-[0.4em] text-ember block mb-2">Search name</label>
                                <input id="artifactSearchInput" type="text" placeholder="e.g. Bronze, textile, expedition"
                                    class="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3">
                            </div>
                            <div>
                                <label class="text-xs uppercase tracking-[0.3em] text-ember block mb-2">From</label>
                                <input id="artifactStartYear" type="number" min="-5000" max="2025" value="-5000"
                                    class="w-32 bg-black/40 border border-white/10 rounded-xl px-3 py-2">
                            </div>
                            <div>
                                <label class="text-xs uppercase tracking-[0.3em] text-ember block mb-2">To</label>
                                <input id="artifactEndYear" type="number" min="-5000" max="2025" value="2025"
                                    class="w-32 bg-black/40 border border-white/10 rounded-xl px-3 py-2">
                            </div>
                        </div>
                        <div>
                            <p class="text-xs uppercase tracking-[0.4em] text-ember mb-2">Matching artifacts</p>
                            <div id="artifactResults" class="space-y-4"></div>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-o9N1j7kGStNvnt+I1b0u0sQ2QpQbATfF4vJf8gEsG6k=" crossorigin=""></script>
    <script>
        if (window.lucide?.createIcons) {
            window.lucide.createIcons();
        }
        const htmlAtlasEndpoint = document.documentElement?.dataset?.atlasEndpoint ?? "";
        const scriptedAtlasEndpoint = window.HISTOCOIN_ATLAS_ENDPOINT ?? window.HISTOCOIN_ATLAS_API ?? "";
        let atlasRemoteEndpoint = deriveAtlasEndpoint(scriptedAtlasEndpoint || htmlAtlasEndpoint);
        const ATLAS_STATIC_URL = "config/atlas-index.json";
        const ATLAS_CONFIG_URL = "config/atlas-config.json";
        const atlasModal = document.getElementById("atlasModal");
        const atlasTriggers = document.querySelectorAll("[data-open-atlas]");
        const closeAtlasBtn = document.getElementById("closeAtlasBtn");
        const timelineStartSlider = document.getElementById("timelineStartSlider");
        const timelineEndSlider = document.getElementById("timelineEndSlider");
        const timelineStartLabel = document.getElementById("timelineStartLabel");
        const timelineEndLabel = document.getElementById("timelineEndLabel");
        const timelineLabel = document.getElementById("timelineLabel");
        const timelineReset = document.getElementById("timelineReset");
        const viewButtons = document.querySelectorAll(".atlas-tab");
        const viewSections = document.querySelectorAll("[data-view]");
        const sourcesList = document.getElementById("sourcesList");
        const artifactResults = document.getElementById("artifactResults");
        const artifactSearchInput = document.getElementById("artifactSearchInput");
        const artifactStartYear = document.getElementById("artifactStartYear");
        const artifactEndYear = document.getElementById("artifactEndYear");
        const TIMELINE_MIN = Number(timelineStartSlider?.min ?? -5000);
        const TIMELINE_MAX = Number(timelineEndSlider?.max ?? 2025);
        let atlasMap;
        let artifactMarkers = [];
        let activeView = "atlas";
        let atlasDataLoaded = false;

        if (timelineStartSlider) {
            timelineStartSlider.value = timelineStartSlider.min || `${TIMELINE_MIN}`;
        }
        if (timelineEndSlider) {
            timelineEndSlider.value = timelineEndSlider.max || `${TIMELINE_MAX}`;
        }
        syncYearInputsFromSlider();
        updateTimelineLabel();

        const FALLBACK_ARTIFACTS = [
            { id: "fallback-1", title: "Sumerian Trade Tablet", year: -3200, lat: 30.964, lng: 46.105, region: "Uruk", sourceName: "Fallback", summary: "Clay ledger documenting grain shipments.", caption: "Transport log etched into clay." },
            { id: "fallback-2", title: "Harappan Bead Workshop", year: -2100, lat: 28.6139, lng: 77.209, region: "Indus Valley", sourceName: "Fallback", summary: "Shell bead catalog uncovered near Rakhigarhi.", caption: "Workshop inventory plate." },
            { id: "fallback-3", title: "Benin Bronze Plaque", year: 1550, lat: 6.34, lng: 5.62, region: "Benin City", sourceName: "Fallback", summary: "Royal court relief with Portuguese regalia.", caption: "Oba procession cast in brass." },
            { id: "fallback-4", title: "Andean Textile Fragment", year: 1450, lat: -13.5, lng: -72.0, region: "Cusco", sourceName: "Fallback", summary: "Dyed camelid fibers woven in stepped motifs.", caption: "Quipu cord dyed with cochineal." },
            { id: "fallback-5", title: "Trade Beads Cache", year: 1750, lat: 51.5074, lng: -0.1278, region: "London", sourceName: "Fallback", summary: "Recovered ballast crate with Venetian glass beads.", caption: "Venetian beads catalog tag." },
            { id: "fallback-6", title: "Arctic Expedition Journal", year: 1898, lat: 64.1466, lng: -21.9426, region: "Reykjavík", sourceName: "Fallback", summary: "Field diary from Guðmundsson sled survey.", caption: "Graphite log from sled survey." },
            { id: "fallback-7", title: "Civil Rights Photo Archive", year: 1964, lat: 33.749, lng: -84.388, region: "Atlanta", sourceName: "Fallback", summary: "35mm negatives from SNCC organizers.", caption: "Contact sheet annotated by SNCC." }
        ];

        const FALLBACK_SOURCES = [
            { id: "fallback-src-1", name: "Smithsonian Open Access", url: "https://www.si.edu/openaccess", region: "Global", type: "Institution", artifactCount: 1200, status: "Live" },
            { id: "fallback-src-2", name: "Europeana Foundation", url: "https://www.europeana.eu", region: "Europe", type: "Consortium", artifactCount: 980, status: "Live" },
            { id: "fallback-src-3", name: "Digital Benin", url: "https://digitalbenin.org", region: "West Africa", type: "Community", artifactCount: 214, status: "Live" },
            { id: "fallback-src-4", name: "Andean Textile Archive", url: "https://andeantextiles.org", region: "South America", type: "Research Lab", artifactCount: 96, status: "Sampling" },
            { id: "fallback-src-5", name: "NOAA Arctic Logs", url: "https://data.noaa.gov/arctic", region: "Arctic Circle", type: "Government", artifactCount: 61, status: "Nightly" }
        ];

        let atlasData = {
            sources: FALLBACK_SOURCES,
            artifacts: FALLBACK_ARTIFACTS,
        };

                function deriveAtlasEndpoint(rawValue) {
                    if (typeof rawValue !== "string") return null;
                    const trimmed = rawValue.trim();
                    if (!trimmed) return null;
                    if (!/^https?:/i.test(trimmed)) return null;
                    if (/\/api\//i.test(trimmed)) {
                        return trimmed;
                    }
                    return `${trimmed.replace(/\/$/, "")}/api/atlas`;
                }

        async function ensureAtlasEndpoint() {
            if (atlasRemoteEndpoint) {
                return atlasRemoteEndpoint;
            }
            try {
                const response = await fetch(ATLAS_CONFIG_URL, { cache: "no-store" });
                if (response.ok) {
                    const config = await response.json();
                    const candidate = deriveAtlasEndpoint(
                        config.workerEndpoint || config.endpoint || config.url || config.atlasEndpoint
                    );
                    if (candidate) {
                        atlasRemoteEndpoint = candidate;
                    }
                }
            } catch (error) {
                console.warn("Atlas config lookup failed", error);
            }
            return atlasRemoteEndpoint;
        }

        function formatYear(year) {
            if (year < 0) return `${Math.abs(year)} BCE`;
            if (year === 0) return "0 CE";
            return `${year} CE`;
        }

        function getTimelineRange() {
            const start = Number(timelineStartSlider?.value ?? TIMELINE_MIN);
            const end = Number(timelineEndSlider?.value ?? TIMELINE_MAX);
            return { start, end };
        }

        function updateTimelineLabel() {
            const { start, end } = getTimelineRange();
            const coversAll = start <= TIMELINE_MIN && end >= TIMELINE_MAX;
            timelineLabel.textContent = coversAll ? "All years" : `${formatYear(start)} – ${formatYear(end)}`;
            if (timelineStartLabel) timelineStartLabel.textContent = formatYear(start);
            if (timelineEndLabel) timelineEndLabel.textContent = formatYear(end);
        }

        function clampYearValue(rawValue, fallback) {
            const numeric = Number(rawValue);
            if (Number.isNaN(numeric)) return fallback;
            return Math.max(TIMELINE_MIN, Math.min(TIMELINE_MAX, numeric));
        }

        function syncYearInputsFromSlider() {
            if (timelineStartSlider && artifactStartYear) {
                artifactStartYear.value = timelineStartSlider.value;
            }
            if (timelineEndSlider && artifactEndYear) {
                artifactEndYear.value = timelineEndSlider.value;
            }
        }

        function syncSlidersFromInputs() {
            if (!timelineStartSlider || !timelineEndSlider) return;
            const start = clampYearValue(artifactStartYear?.value ?? timelineStartSlider.value, TIMELINE_MIN);
            const end = clampYearValue(artifactEndYear?.value ?? timelineEndSlider.value, TIMELINE_MAX);
            const normalizedStart = Math.min(start, end);
            const normalizedEnd = Math.max(start, end);
            timelineStartSlider.value = `${normalizedStart}`;
            timelineEndSlider.value = `${normalizedEnd}`;
            if (artifactStartYear) artifactStartYear.value = `${normalizedStart}`;
            if (artifactEndYear) artifactEndYear.value = `${normalizedEnd}`;
            updateTimelineLabel();
        }

        function handleStartSliderInput() {
            if (!timelineStartSlider || !timelineEndSlider) return;
            if (Number(timelineStartSlider.value) > Number(timelineEndSlider.value)) {
                timelineEndSlider.value = timelineStartSlider.value;
            }
            syncYearInputsFromSlider();
            updateTimelineLabel();
            renderArtifactResults();
            updateMarkers();
        }

        function handleEndSliderInput() {
            if (!timelineStartSlider || !timelineEndSlider) return;
            if (Number(timelineEndSlider.value) < Number(timelineStartSlider.value)) {
                timelineStartSlider.value = timelineEndSlider.value;
            }
            syncYearInputsFromSlider();
            updateTimelineLabel();
            renderArtifactResults();
            updateMarkers();
        }

        function handleTimelineReset() {
            if (timelineStartSlider) {
                timelineStartSlider.value = `${TIMELINE_MIN}`;
            }
            if (timelineEndSlider) {
                timelineEndSlider.value = `${TIMELINE_MAX}`;
            }
            syncYearInputsFromSlider();
            updateTimelineLabel();
            renderArtifactResults();
            updateMarkers();
        }

        function handleYearInputs() {
            syncSlidersFromInputs();
            renderArtifactResults();
            updateMarkers();
        }

        async function ensureAtlasData(forceReload = false) {
            if (atlasDataLoaded && !forceReload) {
                return atlasData;
            }
            let resolved = false;
            const remoteEndpoint = await ensureAtlasEndpoint();
            if (remoteEndpoint) {
                try {
                    const response = await fetch(remoteEndpoint, { cache: "no-store" });
                    if (!response.ok) {
                        throw new Error(`Atlas worker request failed: ${response.status}`);
                    }
                    const payload = await response.json();
                    const sources = Array.isArray(payload.sources) && payload.sources.length ? payload.sources : FALLBACK_SOURCES;
                    const artifacts = Array.isArray(payload.artifacts) && payload.artifacts.length ? payload.artifacts : FALLBACK_ARTIFACTS;
                    atlasData = { sources, artifacts };
                    resolved = true;
                } catch (error) {
                    console.warn("Atlas worker unavailable; falling back to bundled data", error);
                }
            }
            if (!resolved) {
                try {
                    const response = await fetch(ATLAS_STATIC_URL, { cache: "no-store" });
                    if (!response.ok) {
                        throw new Error(`Atlas index request failed: ${response.status}`);
                    }
                    const fileData = await response.json();
                    const sources = Array.isArray(fileData.sources) && fileData.sources.length ? fileData.sources : FALLBACK_SOURCES;
                    const artifacts = Array.isArray(fileData.artifacts) && fileData.artifacts.length ? fileData.artifacts : FALLBACK_ARTIFACTS;
                    atlasData = { sources, artifacts };
                } catch (error) {
                    console.warn("Unable to load atlas index; reverting to inline fallback", error);
                    atlasData = { sources: FALLBACK_SOURCES, artifacts: FALLBACK_ARTIFACTS };
                }
            }
            atlasDataLoaded = true;
            renderSourcesList();
            renderArtifactResults();
            updateMarkers();
            return atlasData;
        }

        function setActiveView(view) {
            activeView = view;
            viewSections.forEach((section) => {
                const isMatch = section.dataset.view === view;
                section.classList.toggle("hidden", !isMatch);
            });
            viewButtons.forEach((btn) => {
                const isActive = btn.dataset.viewTarget === view;
                btn.classList.toggle("is-active", isActive);
                btn.setAttribute("aria-pressed", String(isActive));
            });
            if (view === "atlas") {
                ensureAtlasData();
                ensureAtlas();
            } else if (!atlasDataLoaded) {
                ensureAtlasData();
            }
            timelineReset?.classList.toggle("opacity-40", view !== "atlas");
            timelineReset?.classList.toggle("pointer-events-none", view !== "atlas");
        }

        function renderSourcesList() {
            if (!sourcesList) return;
            sourcesList.innerHTML = "";
            atlasData.sources.forEach((source) => {
                const card = document.createElement("article");
                card.className = "glass rounded-2xl p-5 flex flex-col gap-3";
                const sourceUrl = source.baseUrl || source.url;
                card.innerHTML = `
                    <div class="flex items-center justify-between gap-4">
                        <div>
                            <p class="text-sm text-gray-400 uppercase tracking-[0.3em]">${source.type || "Source"}</p>
                            <h4 class="text-lg font-semibold">${source.name}</h4>
                        </div>
                        <span class="text-sm text-ember font-semibold">${source.artifactCount ?? "—"} items</span>
                    </div>
                    <p class="text-sm text-gray-300 break-all">${sourceUrl || "Unknown URL"}</p>
                    <div class="text-xs text-gray-400 flex justify-between">
                        <span>${source.region ?? "Unknown region"}</span>
                        <span>${source.status ?? "Pending"}</span>
                    </div>
                `;
                sourcesList.appendChild(card);
            });
        }

        function renderArtifactResults() {
            if (!artifactResults) return;
            const searchTerm = artifactSearchInput?.value.trim().toLowerCase() ?? "";
            const parseYearInput = (inputEl, fallback) => {
                if (!inputEl) return fallback;
                const raw = inputEl.value?.trim();
                if (raw === undefined || raw === "") return fallback;
                const parsed = Number(raw);
                return Number.isNaN(parsed) ? fallback : parsed;
            };
            const start = parseYearInput(artifactStartYear, TIMELINE_MIN);
            const end = parseYearInput(artifactEndYear, TIMELINE_MAX);
            const filtered = atlasData.artifacts
                .filter((artifact) => {
                    const hasYear = typeof artifact.year === "number";
                    const withinRange = !hasYear || (artifact.year >= start && artifact.year <= end);
                    const corpus = `${artifact.title} ${artifact.summary ?? ""} ${artifact.caption ?? ""} ${artifact.region ?? ""} ${artifact.sourceName ?? ""}`.toLowerCase();
                    const matchesTerm = !searchTerm || corpus.includes(searchTerm);
                    return withinRange && matchesTerm;
                })
                .sort((a, b) => (b.year ?? Number.MIN_SAFE_INTEGER) - (a.year ?? Number.MIN_SAFE_INTEGER));

            artifactResults.innerHTML = "";
            if (!filtered.length) {
                artifactResults.innerHTML = `<p class="text-gray-400 text-sm">No artifacts match the current filters.</p>`;
                return;
            }
            filtered.forEach((artifact) => {
                const row = document.createElement("article");
                row.className = "glass rounded-2xl p-5";
                row.innerHTML = `
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                        <div>
                            <p class="text-sm text-gray-400 uppercase tracking-[0.3em]">${artifact.region || artifact.sourceName || "Unknown locale"}</p>
                            <h4 class="text-lg font-semibold">${artifact.title}</h4>
                            <p class="text-xs text-gray-500">${artifact.sourceName || "Unattributed"}</p>
                        </div>
                        <p class="text-sm text-ember">${typeof artifact.year === "number" ? formatYear(artifact.year) : "Year unknown"}</p>
                    </div>
                    <p class="text-sm text-gray-300 mt-2">${artifact.caption || artifact.summary || "No description"}</p>
                `;
                artifactResults.appendChild(row);
            });
        }

        function openModal() {
            atlasModal.classList.remove("hidden");
            document.body.classList.add("overflow-hidden");
            ensureAtlas();
        }

        function closeModal() {
            atlasModal.classList.add("hidden");
            document.body.classList.remove("overflow-hidden");
        }

        function ensureAtlas() {
            if (typeof L === "undefined") {
                console.warn("Leaflet failed to load; cannot render atlas map.");
                return;
            }
            if (atlasMap) {
                atlasMap.invalidateSize();
                return;
            }
            atlasMap = L.map("atlasMap", { worldCopyJump: true }).setView([20, 0], 2);
            L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                attribution: "&copy; OpenStreetMap",
            }).addTo(atlasMap);
            updateMarkers();
        }

        function updateMarkers() {
            if (!atlasMap || typeof L === "undefined") return;
            const { start, end } = getTimelineRange();
            artifactMarkers.forEach((marker) => marker.remove());
            artifactMarkers = [];
            const dataset = Array.isArray(atlasData.artifacts) ? atlasData.artifacts : [];
            const candidates = dataset.filter((artifact) => typeof artifact.lat === "number" && typeof artifact.lng === "number");
            const filtered = candidates.filter((artifact) => {
                if (typeof artifact.year !== "number") return true;
                return artifact.year >= start && artifact.year <= end;
            });
            artifactMarkers = filtered.map((artifact) => {
                const popupParts = [`<strong>${artifact.title}</strong>`];
                if (typeof artifact.year === "number") popupParts.push(formatYear(artifact.year));
                if (artifact.sourceName) popupParts.push(artifact.sourceName);
                if (artifact.caption) popupParts.push(artifact.caption);
                return L.circleMarker([artifact.lat, artifact.lng], {
                    radius: 7,
                    color: "#9ca3af",
                    fillColor: "#9ca3af",
                    weight: 1,
                    fillOpacity: 0.45,
                })
                    .addTo(atlasMap)
                    .bindPopup(popupParts.filter(Boolean).join("<br>"));
            });
            updateTimelineLabel();
        }

        atlasTriggers.forEach((el) => el.addEventListener("click", () => {
            setActiveView("atlas");
            openModal();
        }));
        closeAtlasBtn?.addEventListener("click", closeModal);
        timelineStartSlider?.addEventListener("input", handleStartSliderInput);
        timelineEndSlider?.addEventListener("input", handleEndSliderInput);
        timelineReset?.addEventListener("click", handleTimelineReset);
        viewButtons.forEach((btn) => btn.addEventListener("click", () => setActiveView(btn.dataset.viewTarget)));
        artifactSearchInput?.addEventListener("input", renderArtifactResults);
        artifactStartYear?.addEventListener("input", handleYearInputs);
        artifactEndYear?.addEventListener("input", handleYearInputs);
        atlasModal?.addEventListener("click", (event) => {
            if (event.target === atlasModal) {
                closeModal();
            }
        });
        document.addEventListener("keydown", (event) => {
            if (event.key === "Escape" && !atlasModal.classList.contains("hidden")) {
                closeModal();
            }
        });

        renderSourcesList();
        renderArtifactResults();
        ensureAtlasData();
        setActiveView("atlas");
    </script>
</body>

</html>